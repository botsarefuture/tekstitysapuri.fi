{% extends "base.html" %}

{% block title %}Transcription Status - Tekstitysapuri.fi{% endblock %}

{% block content %}
<style>
    body {
        background-color: #2962FF;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100vh;
        margin: 0;
    }

    .status-container {
        text-align: center;
        color: white;
    }

    .progress-ring {
        width: 120px;
        height: 120px;
    }

    .progress-ring__circle {
        stroke: white;
        stroke-width: 8;
        fill: transparent;
        r: 52;
        cx: 60;
        cy: 60;
        transform: rotate(-90deg);
        transform-origin: 50% 50%;
        transition: stroke-dashoffset 0.35s;
    }
</style>

<h1 class="status-container">Transcription Status</h1>
<div class="status-container">
    <p>Status: <span id="transcriptionStatus">Loading...</span></p>
    <svg class="progress-ring">
        <circle class="progress-ring__circle" />
    </svg>
</div>

<script>
    var circle = document.querySelector('circle');
    var radius = circle.r.baseVal.value;
    var circumference = radius * 2 * Math.PI;

    circle.style.strokeDasharray = `${circumference} ${circumference}`;
    circle.style.strokeDashoffset = `${circumference}`;

    function setProgress(percent) {
        const offset = circumference - percent / 100 * circumference;
        circle.style.strokeDashoffset = offset;
    }

    // Function to fetch and update the transcription status
    function updateStatus() {
        // Get the job_id from the URL
        const result_id = window.location.pathname.split('/').pop();

        // Fetch the status and progress from the server
        fetch(`/get_status/${result_id}`)
            .then(response => response.json())
            .then(data => {
                const statusElement = document.getElementById('transcriptionStatus');

                if (statusElement) {
                    // Display only the progress percentage
                    statusElement.textContent = `${data.progress || 0}%`;

                    // Check if status is "completed" and redirect if true
                    if (data.status === 'completed') {
                        window.location.href = `/result/${result_id}`;
                    }
                }
            })
            .catch(error => console.error('Error fetching transcription status:', error));
    }

    // Initial update and then set interval to update every second
    updateStatus();
    setInterval(updateStatus, 1000);
</script>

{% endblock %}
